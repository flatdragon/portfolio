name: Main Workflow

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

env:
  HEROKU_API_KEY: ${{ secrets.HEROKU_API_KEY }}

jobs:
  deploy-backend-app-to-heroku:
    name: Deploy Backend to Heroku
    runs-on: ubuntu-20.04
    env:
      HEROKU_APP: ${{ secrets.HEROKU_BACKEND_APP }}
      REPO: ${{ github.repository }}
      SHA: $(echo "${{ github.sha }}" | cut -c1-7)
    steps:

      - name: Checkout Main Branch
        uses: actions/checkout@v2
        with:
          path: sources

      - name: Login to Heroku
        run: heroku container:login
      
      - name: Check Backend Existence
        id: check_backend_existence
        run: |
          if [ -z "$(heroku apps:info --shell)" ]
          then
            existence="not exists"
          else
            existence="exists"
          fi
          echo "Backend app ${existence}."
          echo "::set-output name=result::$(echo ${existence})\n"

      - name: Create Backend App at Heroku (Conditionally)
        if: ${{ steps.check_backend_existence.outputs.result == "not exists" }}
        run: |
          heroku apps:create $HEROKU_APP --region eu
          heroku addons:create heroku-postgresql:hobby-dev
          heroku buildpacks:add heroku/php
          heroku buildpacks:add heroku/nodejs

      - name: Create Temporary Directory for Deployment
        run: mkdir deployment

      - name: Connect to Heroku Git
        run: |
          cd deployment
          git init
          git config user.name github-actions
          git config user.email github-actions@github.com
          git remote add heroku https://heroku:${HEROKU_API_KEY}@git.heroku.com/${HEROKU_APP}.git

      - name: Enter Maintenance Mode at Heroku
        run: |
          heroku maintenance:on
          heroku config:set APP_ENV="staging"

      - name: Make Initial Commit (Conditionally)
        run: |
          cd deployment
          if [ -z "$(git ls-remote --heads heroku master)" ]
          then
            git commit --allow-empty -m "init project"
            git push heroku master
          fi

      - name: Commit Backend Changes
        run: |
          cd deployment
          git pull --ff-only heroku master
          cp -a ../sources/backend/. .
          if [ -z "$(git status --porcelain)" ]
          then
            echo "Backend is up to date. Going to the next step..."
          else
            git commit -am "deploy backend app from https://github.com/${REPO}/tree/${SHA}"
            git push heroku master
          fi

      - name: Set Backend Env Variables
        run: |
          heroku config:set APP_URL=$(heroku apps:info --shell | grep web_url | cut -d= -f2)

          if [ -z "$(heroku config:get APP_KEY)" ]
          then
            heroku config:set APP_KEY=$(heroku run php artisan key:generate --show)
          fi

          if [ -z "$(heroku config:get DATABASE_URL)" ]
          then
            heroku config:set DATABASE_URL=$(heroku config:get HEROKU_POSTGRESQL)
          fi

      - name: Migrate Database
        run: heroku run php artisan migrate

      - name: Leave Maintenance Mode at Heroku
        run: |
          heroku config:set APP_ENV="production"
          heroku maintenance:off
